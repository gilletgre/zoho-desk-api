<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Portail Support - Tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
    :root {
      --bg: #0f172a;
      --bg-card: #0b1220;
      --bg-soft: #020617;
      --accent: #60a5fa;
      --accent-soft: rgba(59,130,246,0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148,163,184,0.25);
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #eab308;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(96,165,250,0.12), transparent 30%), radial-gradient(circle at 80% 0%, rgba(45,212,191,0.12), transparent 28%), #020617;
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 10% 5% auto auto;
      width: 380px;
      height: 380px;
      background: radial-gradient(circle, rgba(96,165,250,0.08) 0, transparent 55%);
      filter: blur(12px);
      z-index: 0;
      pointer-events: none;
    }

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,0.08), rgba(2,6,23,0.95));
      backdrop-filter: blur(10px);
      z-index: 5;
      padding: 18px;
    }

    .auth-card {
      background: linear-gradient(140deg, rgba(15,23,42,0.9), rgba(30,41,59,0.85));
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 16px;
      padding: 22px 20px 20px;
      width: min(420px, 100%);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35), 0 0 0 1px rgba(148,163,184,0.1) inset;
      position: relative;
      overflow: hidden;
    }

    .auth-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 0, rgba(96,165,250,0.12), transparent 40%);
      pointer-events: none;
    }

    .auth-card h2 {
      margin: 8px 0 4px;
    }

    .auth-card p {
      margin: 0 0 12px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.7);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      margin-bottom: 10px;
    }

    .auth-input:focus {
      border-color: rgba(96,165,250,0.7);
      box-shadow: 0 0 0 1px rgba(96,165,250,0.4);
    }

    .auth-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .auth-button {
      flex: 1;
      border: 1px solid rgba(96,165,250,0.6);
      background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.08));
      color: var(--text-main);
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .auth-error {
      color: var(--danger);
      font-size: 13px;
      min-height: 18px;
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 28px 18px 48px;
      width: 100%;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 12px;
      position: relative;
      z-index: 1;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #60a5fa, #22d3ee);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #0b1120;
      box-shadow: 0 10px 30px rgba(59,130,246,0.55);
    }

    h1 {
      margin: 0;
      font-size: 24px;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15,23,42,0.7);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 20px;
      align-items: flex-start;
      position: relative;
      z-index: 1;
    }

    .layout > section {
      min-width: 0;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(145deg, rgba(30,41,59,0.65), rgba(15,23,42,0.9));
      border-radius: 18px;
      padding: 16px 16px 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 35px rgba(15,23,42,0.7), 0 0 0 1px rgba(148,163,184,0.08) inset;
      backdrop-filter: blur(6px);
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .card p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .card + .card {
      margin-top: 12px;
    }

    /* Liste des tickets */
    .tickets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .tickets-header h2 {
      margin: 0;
      font-size: 16px;
    }

    #refreshBtn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 6px 14px;
      font-size: 13px;
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.05));
      color: var(--text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #refreshBtn:hover {
      border-color: rgba(129,140,248,0.9);
      box-shadow: 0 0 0 1px rgba(99,102,241,0.7);
    }

    #refreshBtn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    #error {
      margin-top: 8px;
      font-size: 13px;
      color: var(--danger);
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
      table-layout: auto;
    }

    th, td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(15,23,42,0.85);
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: top;
    }

    /* Forcer des colonnes non-wrap pour les identifiants/dates */
    th:first-child, td:first-child,
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5) {
      white-space: nowrap;
    }

    /* Le sujet peut s'étendre sur plusieurs lignes */
    th:nth-child(2), td:nth-child(2) {
      white-space: normal;
      max-width: 420px;
      word-break: break-word;
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .04em;
      background: rgba(15,23,42,0.8);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:hover {
      background: linear-gradient(90deg, rgba(59,130,246,0.09), rgba(15,23,42,0.9));
      cursor: pointer;
    }

    tbody tr {
      transition: transform 120ms ease, background 120ms ease;
    }

    tbody tr:active {
      transform: scale(0.995);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-status-open {
      background: rgba(34,197,94,0.12);
      color: #4ade80;
      border: 1px solid rgba(34,197,94,0.5);
    }

    .badge-status-closed {
      background: rgba(148,163,184,0.16);
      color: #cbd5f5;
      border: 1px solid rgba(148,163,184,0.6);
    }

    .badge-status-onhold {
      background: rgba(234,179,8,0.15);
      color: #facc15;
      border: 1px solid rgba(234,179,8,0.65);
    }

    .badge-priority-high {
      background: rgba(248,113,113,0.18);
      color: #fb7185;
      border: 1px solid rgba(248,113,113,0.7);
    }

    .badge-priority-normal {
      background: rgba(59,130,246,0.14);
      color: #93c5fd;
      border: 1px solid rgba(59,130,246,0.6);
    }

    .ticket-subject {
      max-width: 260px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #noTickets {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Détail & historique */

    #detailsCard p {
      margin-bottom: 4px;
    }

    #detailsCard hr {
      border: none;
      border-top: 1px solid rgba(148,163,184,0.25);
      margin: 10px 0;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 6px 12px;
      font-size: 12px;
    }

    .meta-label {
      color: var(--text-muted);
    }

    .meta-value {
      font-weight: 500;
    }

    #detailsContent a {
      color: #93c5fd;
      text-decoration: none;
    }

    #detailsContent {
      line-height: 1.5;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    #detailsContent a:hover {
      text-decoration: underline;
    }

    #historyList {
      list-style: none;
      padding-left: 0;
      margin: 8px 0 0;
      max-height: 260px;
      overflow-y: auto;
      font-size: 12px;
    }

    #historyList li {
      padding: 4px 0;
      border-bottom: 1px solid rgba(15,23,42,0.9);
      color: var(--text-muted);
      word-break: break-word;
    }

    .history-time {
      color: var(--text-main);
      font-weight: 500;
    }

    .debug-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .debug-tab {
      border: 1px solid var(--border-subtle);
      background: rgba(59,130,246,0.06);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .debug-tab.active {
      border-color: rgba(59,130,246,0.6);
      background: rgba(59,130,246,0.15);
    }

    .debug-pre {
      background: var(--bg-soft);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 12px;
      color: var(--text-main);
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 12px;
      max-height: 360px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Statistiques */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin: 10px 0 20px;
      position: relative;
      z-index: 1;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(59,130,246,0.14), rgba(15,23,42,0.9));
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.45);
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 12px;
      letter-spacing: .02em;
    }

    .stat-value {
      font-size: 26px;
      font-weight: 700;
      line-height: 1.2;
    }

    .stat-hint {
      font-size: 12px;
      color: rgba(226,232,240,0.75);
    }

    /* Callouts & chips */
    .callout {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.25);
      background: radial-gradient(circle at 10% 10%, rgba(59,130,246,0.12), rgba(15,23,42,0.92));
      margin: 10px 0;
    }

    .callout-label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: .08em;
      margin-bottom: 4px;
    }

    .callout-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .callout-body {
      color: var(--text-muted);
      line-height: 1.5;
      font-size: 13px;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .pill-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }

    .pill-card {
      padding: 10px 12px;
      background: rgba(15,23,42,0.75);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 10px;
    }

    .pill-card .meta-label {
      font-size: 11px;
    }

    .pill-card .meta-value {
      font-size: 18px;
      margin-top: 2px;
    }

    /* Decorative grid */
    .grid-overlay {
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 32px 32px;
      mask-image: radial-gradient(circle at center, rgba(0,0,0,0.22), transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    @media (max-width: 700px) {
      .stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
      }
      .card {
        padding: 14px 12px 16px;
      }
      .callout-title {
        font-size: 15px;
      }
      th:nth-child(2), td:nth-child(2) {
        max-width: 100%;
      }
    }

    @media (max-width: 520px) {
      .stat-grid {
        grid-template-columns: 1fr;
      }
      #detailsCard h2, #historyCard h2 {
        font-size: 15px;
      }
      .meta-grid {
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      }
    }

  </style>
</head>
<body>
  <div class="grid-overlay"></div>
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
      <div class="brand">
        <div class="brand-logo">C</div>
        <div>
          <h2>Accès protégé</h2>
          <p>Entrez le mot de passe partagé pour accéder au portail de support.</p>
        </div>
      </div>
      <input class="auth-input" id="authPassword" type="password" placeholder="Mot de passe" autocomplete="current-password" />
      <div class="auth-actions">
        <button id="authSubmit" class="auth-button">Déverrouiller</button>
      </div>
      <div class="auth-error" id="authError"></div>
    </div>
  </div>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-logo">C</div>
        <div>
          <h1>Tickets de votre support</h1>
          <p class="subtitle">Portail client connecté à Zoho Desk</p>
        </div>
      </div>
      <div class="header-actions">
        <span class="pill">Compte : My Digital Portal</span>
        <span class="pill">Cartronics</span>
      </div>
    </header>

    <section class="stat-grid" id="statsBar">
      <div class="stat-card">
        <div class="stat-label">Tickets</div>
        <div class="stat-value" id="statTotal">--</div>
        <div class="stat-hint">Total suivis</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ouverts</div>
        <div class="stat-value" id="statOpen">--</div>
        <div class="stat-hint">En cours</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Clôturés</div>
        <div class="stat-value" id="statClosed">--</div>
        <div class="stat-hint">Résolus</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Priorité haute</div>
        <div class="stat-value" id="statHigh">--</div>
        <div class="stat-hint">À surveiller</div>
      </div>
    </section>

    <main class="layout">
      <!-- Colonne gauche : liste -->
      <section class="card">
        <div class="tickets-header">
          <div>
            <h2>Tickets</h2>
            <p>Cliquez sur un ticket pour voir les détails.</p>
          </div>
          <button id="refreshBtn">Actualiser</button>
        </div>
        <div id="error"></div>

        <div class="table-wrapper">
          <table id="ticketsTable" style="display:none;">
            <thead>
            <tr>
              <th>N°</th>
              <th>Sujet</th>
              <th>Statut</th>
              <th>Priorité</th>
              <th>Créé le</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p id="noTickets" style="display:none;">Aucun ticket trouvé pour ce compte.</p>
      </section>

      <!-- Colonne droite : détail + historique -->
      <section>
        <div class="card" id="detailsCard" style="display:none;">
          <h2>Détail du ticket</h2>
          <div id="detailsContent"></div>
        </div>

        <div class="card" id="historyCard" style="display:none;">
          <h2>Historique du ticket</h2>
          <ul id="historyList"></ul>
        </div>

        <div class="card" id="debugCard" style="display:none;">
          <div class="tickets-header" style="margin-bottom:8px;">
            <div>
              <h2>Données API brutes</h2>
              <p class="subtitle">Inspectez tout ce que Zoho renvoie pour ce ticket.</p>
            </div>
            <span class="pill">Vue debug</span>
          </div>
          <div class="debug-tabs">
            <button class="debug-tab active" data-tab="details">Ticket</button>
            <button class="debug-tab" data-tab="history">Historique</button>
          </div>
          <pre class="debug-pre" id="debugDetails"></pre>
          <pre class="debug-pre" id="debugHistory" style="display:none;"></pre>
        </div>
      </section>
    </main>
  </div>

  <script>
    const refreshBtn = document.getElementById('refreshBtn');
    const errorDiv = document.getElementById('error');
    const table = document.getElementById('ticketsTable');
    const tbody = table.querySelector('tbody');
    const noTickets = document.getElementById('noTickets');
    const detailsCard = document.getElementById('detailsCard');
    const detailsContent = document.getElementById('detailsContent');
    const historyCard = document.getElementById('historyCard');
    const historyList = document.getElementById('historyList');
    const debugCard = document.getElementById('debugCard');
    const debugDetails = document.getElementById('debugDetails');
    const debugHistory = document.getElementById('debugHistory');
    const debugTabs = Array.from(document.querySelectorAll('.debug-tab'));
    const statTotal = document.getElementById('statTotal');
    const statOpen = document.getElementById('statOpen');
    const statClosed = document.getElementById('statClosed');
    const statHigh = document.getElementById('statHigh');
    const authOverlay = document.getElementById('authOverlay');
    const authPassword = document.getElementById('authPassword');
    const authSubmit = document.getElementById('authSubmit');
    const authError = document.getElementById('authError');
    const DEBUG_ENABLED = false;
    let ticketsCache = [];
    let lastDetails = null;
    let lastHistory = null;
    let lastLayoutFields = null;
    let lastConversations = null;
    let lastThreads = null;
    let lastMessages = null;

    function showAuth(message = '') {
      authOverlay.style.display = 'flex';
      if (message) authError.textContent = message;
      authPassword.focus();
    }

    function hideAuth() {
      authOverlay.style.display = 'none';
      authError.textContent = '';
      authPassword.value = '';
    }

    async function checkSession() {
      try {
        const res = await fetch('/.netlify/functions/auth', { credentials: 'same-origin' });
        if (res.ok) {
          hideAuth();
          return true;
        }
      } catch (e) {
        console.error(e);
      }
      showAuth();
      return false;
    }

    async function login() {
      authError.textContent = '';
      const password = authPassword.value || '';
      if (!password) {
        authError.textContent = 'Veuillez saisir le mot de passe.';
        return;
      }

      authSubmit.disabled = true;
      authSubmit.textContent = 'Vérification...';

      try {
        const res = await fetch('/.netlify/functions/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
          credentials: 'same-origin'
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || 'Accès refusé');
        }
        hideAuth();
        loadTickets();
      } catch (e) {
        console.error(e);
        authError.textContent = e.message || 'Mot de passe incorrect';
      } finally {
        authSubmit.disabled = false;
        authSubmit.textContent = 'Déverrouiller';
      }
    }

    function statusBadge(status) {
      if (!status) return '';
      const s = status.toLowerCase();
      let cls = 'badge-status-closed';
      if (s.includes('open') || s.includes('new')) cls = 'badge-status-open';
      else if (s.includes('hold') || s.includes('en attente')) cls = 'badge-status-onhold';
      return `<span class="badge ${cls}">${status}</span>`;
    }

    function priorityBadge(priority) {
      if (!priority) return '';
      const p = priority.toLowerCase();
      let cls = 'badge-priority-normal';
      if (p.includes('haute') || p.includes('high')) cls = 'badge-priority-high';
      return `<span class="badge ${cls}">${priority}</span>`;
    }

    function renderTickets(tickets = []) {
      table.style.display = 'none';
      tbody.innerHTML = '';
      noTickets.style.display = 'none';

      const filtered = tickets.filter(t => (t.subject || '').toLowerCase().includes('[portal]'));

      if (filtered.length === 0) {
        noTickets.textContent = 'Aucun ticket contenant [Portal].';
        noTickets.style.display = 'block';
        updateStats(filtered);
        return;
      }

      filtered.forEach(t => {
        const tr = document.createElement('tr');
        const created = t.createdTime ? new Date(t.createdTime).toLocaleString() : '';
        tr.innerHTML = `
          <td>${t.ticketNumber || ''}</td>
          <td class="ticket-subject">${t.subject || ''}</td>
          <td>${statusBadge(t.status)}</td>
          <td>${priorityBadge(t.priority)}</td>
          <td>${created}</td>
        `;
        tr.addEventListener('click', () => loadDetails(t.id, t.ticketNumber));
        tbody.appendChild(tr);
      });

      table.style.display = 'table';
      updateStats(filtered);
    }

    function updateStats(tickets = []) {
      const total = tickets.length;
      let open = 0;
      let closed = 0;
      let high = 0;

      tickets.forEach(t => {
        const status = (t.status || '').toLowerCase();
        if (status.includes('clos') || status.includes('ferme') || status.includes('resolved')) {
          closed += 1;
        } else if (status.includes('open') || status.includes('new') || status.includes('ouvert')) {
          open += 1;
        }

        const priority = (t.priority || '').toLowerCase();
        if (priority.includes('haute') || priority.includes('high') || priority.includes('urgent')) {
          high += 1;
        }
      });

      statTotal.textContent = total;
      statOpen.textContent = open;
      statClosed.textContent = closed;
      statHigh.textContent = high;
    }

    async function loadTickets() {
      errorDiv.textContent = '';
      detailsCard.style.display = 'none';
      historyCard.style.display = 'none';
      ticketsCache = [];
      renderTickets([]);

      refreshBtn.disabled = true;
      refreshBtn.textContent = 'Chargement...';

      try {
        const res = await fetch('/.netlify/functions/tickets', { credentials: 'same-origin' });
        const data = await res.json();

        if (!res.ok) {
          if (res.status === 401) {
            showAuth('Session expirée, merci de vous reconnecter.');
          }
          throw new Error(data.error || 'Erreur API tickets');
        }

        const tickets = Array.isArray(data) ? data : [];
        ticketsCache = tickets;
        renderTickets(ticketsCache);
      } catch (e) {
        console.error(e);
        errorDiv.textContent = 'Erreur lors du chargement des tickets : ' + (e.message || '');
        renderTickets([]);
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'Actualiser';
      }
    }

    async function loadDetails(ticketId, ticketNumber) {
      detailsCard.style.display = 'block';
      detailsContent.innerHTML = 'Chargement du ticket ' + ticketNumber + '...';
      historyCard.style.display = 'none';
      historyList.innerHTML = '';
      debugCard.style.display = 'none';
      lastDetails = null;
      lastHistory = null;
      lastLayoutFields = null;
      lastConversations = null;
      lastThreads = null;
      lastMessages = null;

      try {
        const res = await fetch('/.netlify/functions/ticketDetails?id=' + encodeURIComponent(ticketId), {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!res.ok) {
          if (res.status === 401) {
            showAuth('Session expirée, merci de vous reconnecter.');
          }
          const details = data && data.details ? ' - ' + JSON.stringify(data.details) : '';
          throw new Error((data.error || 'Erreur API détail') + details);
        }

        const created = data.createdTime ? new Date(data.createdTime).toLocaleString() : '';
        const closed = data.closedTime ? new Date(data.closedTime).toLocaleString() : '';
        const description = data.description || '(Aucune description disponible)';
        const resolution = data.resolution || '(Aucune résolution encodée)';
        const timeEntries = data.timeEntryCount || '0';
        const attachments = data.attachmentCount || '0';
        const tasks = data.taskCount || '0';

        detailsContent.innerHTML = `
          <div class="meta-grid" style="margin-bottom:12px;">
            <div>
              <div class="meta-label">Ticket</div>
              <div class="meta-value">#${data.ticketNumber}</div>
            </div>
            <div>
              <div class="meta-label">Statut</div>
              <div class="meta-value">${statusBadge(data.status)}</div>
            </div>
            <div>
              <div class="meta-label">Priorité</div>
              <div class="meta-value">${priorityBadge(data.priority) || '-'}</div>
            </div>
            <div>
              <div class="meta-label">Créé le</div>
              <div class="meta-value">${created}</div>
            </div>
            ${closed ? `
            <div>
              <div class="meta-label">Clôturé le</div>
              <div class="meta-value">${closed}</div>
            </div>` : ''}
            <div>
              <div class="meta-label">Email</div>
              <div class="meta-value">${data.email || '-'}</div>
            </div>
          </div>

          <div class="callout">
            <div class="callout-label">Sujet</div>
            <div class="callout-title">${data.subject || ''}</div>
            <div class="callout-body">
              ${data.email ? `<span class="meta-label">Email :</span> <span class="meta-value">${data.email}</span><br/>` : ''}
              <a href="${data.webUrl}" target="_blank">Ouvrir dans Zoho Desk</a>
            </div>
          </div>

          <div class="pill-grid">
            <div class="pill-card">
              <div class="meta-label">Entrées de temps</div>
              <div class="meta-value">${timeEntries}</div>
            </div>
            <div class="pill-card">
              <div class="meta-label">Pièces jointes</div>
              <div class="meta-value">${attachments}</div>
            </div>
            <div class="pill-card">
              <div class="meta-label">Activités</div>
              <div class="meta-value">${tasks}</div>
            </div>
          </div>

          <div class="callout">
            <div class="callout-label">Résolution</div>
            <div class="callout-body" id="resolutionBody">${resolution}</div>
          </div>

          <div class="callout" id="initialContent">
            <div class="callout-label">Contenu initial</div>
            <div class="callout-body" id="initialContentBody">Recherche du contenu...</div>
            <div class="meta-label" id="initialContentSource"></div>
          </div>

          <div class="callout">
            <div class="callout-label">Description</div>
            <div class="callout-body">${description}</div>
          </div>
        `;
        lastDetails = data;
        renderDebug();

        loadHistory(ticketId);
        updateResolutionDisplay();
        // Précharge les champs du layout pour aider à mapper les cf
        if (data && data.layoutId) {
          loadLayoutFields(data.layoutId);
        }
        loadConversations(ticketId);
        loadThreads(ticketId);
        loadMessages(ticketId);
        renderInitialContent();
      } catch (e) {
        console.error(e);
        const msg = e && e.message ? e.message : '';
        detailsContent.innerHTML = 'Erreur lors du chargement du détail du ticket : ' + msg;
      }
    }

    async function loadHistory(ticketId) {
      historyCard.style.display = 'block';
      historyList.innerHTML = '<li>Chargement de l\'historique...</li>';

      try {
        const res = await fetch('/.netlify/functions/ticketHistory?id=' + encodeURIComponent(ticketId), {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!res.ok) {
          if (res.status === 401) {
            showAuth('Session expirée, merci de vous reconnecter.');
          }
          throw new Error(data.error || 'Erreur API historique');
        }

        const events = Array.isArray(data) ? data : [];

        if (events.length === 0) {
          historyList.innerHTML = '<li>Aucun élément d\'historique.</li>';
          return;
        }

        historyList.innerHTML = '';
        events.forEach(ev => {
          const li = document.createElement('li');
          const when = ev.eventTime ? new Date(ev.eventTime).toLocaleString() : '';
          const name = ev.eventName || 'Évènement';
          const actor = ev.actor && ev.actor.name ? ` par ${ev.actor.name}` : '';
          li.innerHTML = `<span class="history-time">${when}</span> - ${name}${actor}`;
          historyList.appendChild(li);
        });
        lastHistory = events;
        renderDebug();
        renderInitialContent();
        updateResolutionDisplay();
      } catch (e) {
        console.error(e);
        historyList.innerHTML = '<li>Erreur lors du chargement de l\'historique.</li>';
        lastHistory = null;
        renderDebug();
      }
    }

    async function loadConversations(ticketId) {
      try {
        const res = await fetch('/.netlify/functions/ticketConversations?id=' + encodeURIComponent(ticketId), {
          credentials: 'same-origin'
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error((data && data.error) || 'Erreur conversations');
        }
        lastConversations = data;
        renderDebug();
        renderInitialContent();
      } catch (e) {
        console.error('Erreur loadConversations', e);
        lastConversations = { error: e.message || 'Erreur' };
        renderDebug();
      }
    }

    async function loadMessages(ticketId) {
      try {
        const res = await fetch('/.netlify/functions/ticketMessages?id=' + encodeURIComponent(ticketId), {
          credentials: 'same-origin'
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error((data && data.error) || 'Erreur messages');
        }
        lastMessages = data;
        renderDebug();
        renderInitialContent();
      } catch (e) {
        console.error('Erreur loadMessages', e);
        lastMessages = { error: e.message || 'Erreur' };
        renderDebug();
      }
    }

    async function loadThreads(ticketId) {
      try {
        const res = await fetch('/.netlify/functions/ticketThreads?id=' + encodeURIComponent(ticketId), {
          credentials: 'same-origin'
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error((data && data.error) || 'Erreur threads');
        }
        lastThreads = data;
        renderDebug();
        renderInitialContent();
      } catch (e) {
        console.error('Erreur loadThreads', e);
        lastThreads = { error: e.message || 'Erreur' };
        renderDebug();
        renderInitialContent();
      }
    }

    async function loadLayoutFields(layoutId) {
      try {
        const res = await fetch('/.netlify/functions/layoutFields?layoutId=' + encodeURIComponent(layoutId), {
          credentials: 'same-origin'
        });
        const data = await res.json();
        if (!res.ok) {
          const detail = data && data.details ? JSON.stringify(data.details) : '';
          throw new Error(((data && data.error) || 'Erreur champs layout') + (detail ? ' ' + detail : ''));
        }
        lastLayoutFields = data;
        renderDebug();
      } catch (e) {
        console.error('Erreur loadLayoutFields', e);
        lastLayoutFields = { error: e.message || 'Erreur' };
        renderDebug();
      }
    }

    function renderDebug() {
      if (!DEBUG_ENABLED) {
        debugCard.style.display = 'none';
        return;
      }
      if (!lastDetails && !lastHistory && !lastLayoutFields && !lastConversations && !lastThreads && !lastMessages) {
        debugCard.style.display = 'none';
        return;
      }

      debugCard.style.display = 'block';
      const composite = {
        ticket: lastDetails || '(vide)',
        cf: (lastDetails && (lastDetails.cf || lastDetails.customFields)) || {},
        layoutId: lastDetails && (lastDetails.layoutId || (lastDetails.layoutDetails && lastDetails.layoutDetails.id)),
        layoutFields: lastLayoutFields || '(non chargé)',
        threads: lastThreads || '(non chargé)',
        messages: lastMessages || '(non chargé)'
      };
      debugDetails.textContent = lastDetails ? JSON.stringify(composite, null, 2) : 'Aucune donnée de ticket.';
      debugHistory.textContent = lastHistory ? JSON.stringify(lastHistory, null, 2) : 'Aucun historique chargé.';
      if (lastConversations) {
        let convText = '';
        if (Array.isArray(lastConversations)) {
          const first = lastConversations[0];
          convText = JSON.stringify(first, null, 2);
        } else {
          convText = JSON.stringify(lastConversations, null, 2);
        }
        // Reuse history pre block for simplicity if tabs not switched
        // We keep conversations in details block to avoid extra tab.
        debugDetails.textContent = lastDetails
          ? JSON.stringify({ ...composite, conversations: lastConversations }, null, 2)
          : convText;
      }
      updateResolutionDisplay();
    }

    function stripHtml(html = '') {
      return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function pickSummary() {
      if (lastDetails && lastDetails.summary) return lastDetails.summary;
      const convs = Array.isArray(lastConversations) ? lastConversations : [];
      const msgs = Array.isArray(lastMessages) ? lastMessages : [];
      if (convs.length) {
        const c = convs.find(x => x.summary) || convs[0];
        if (c && c.summary) return c.summary;
      }
      if (msgs.length) {
        const m = msgs.find(x => x.summary) || msgs[0];
        if (m && m.summary) return m.summary;
      }
      return '';
    }

    function pickHistoryContent() {
      const hist = Array.isArray(lastHistory) ? lastHistory : [];
      for (let i = 0; i < hist.length; i++) {
        const ev = hist[i];
        const info = Array.isArray(ev.eventInfo) ? ev.eventInfo : [];
        const contentProp = info.find(p => (p.propertyName || '').toLowerCase() === 'content');
        if (contentProp && contentProp.propertyValue) {
          const pv = contentProp.propertyValue;
          if (typeof pv === 'string' && pv) {
            return pv;
          }
          if (pv.updatedValue && typeof pv.updatedValue === 'string') {
            return pv.updatedValue;
          }
          if (pv.previousValue && typeof pv.previousValue === 'string') {
            return pv.previousValue;
          }
        }
      }
      return '';
    }

    function extractHistoryNotes() {
      const hist = Array.isArray(lastHistory) ? lastHistory : [];
      const notes = [];
      hist.forEach(ev => {
        const when = ev.eventTime || '';
        const info = Array.isArray(ev.eventInfo) ? ev.eventInfo : [];
        info.forEach(p => {
          const name = (p.propertyName || '').toLowerCase();
          if (name === 'content' || name === 'subject') {
            const pv = p.propertyValue;
            let raw = '';
            if (typeof pv === 'string') raw = pv;
            else if (pv && typeof pv.updatedValue === 'string') raw = pv.updatedValue;
            else if (pv && typeof pv.previousValue === 'string') raw = pv.previousValue;
            if (raw) {
              notes.push({ when, text: stripHtml(raw) || raw });
            }
          }
        });
        if (ev.summary) {
          notes.push({ when, text: stripHtml(ev.summary) || ev.summary });
        }
      });
      return notes;
    }

    function pickInitialContent() {
      const summary = pickSummary();
      if (summary) {
        return { content: summary, source: 'Résumé' };
      }

      if (lastDetails && lastDetails.description) {
        return { content: lastDetails.description, source: 'Description (ticket)' };
      }

      // 0) summary du ticket (souvent corps condensé du mail)
      if (lastDetails && lastDetails.summary) {
        return { content: lastDetails.summary, source: 'Résumé (ticket)' };
      }

      const threadsArr = Array.isArray(lastThreads) ? lastThreads : [];
      const inbound = threadsArr.find(t => {
        const dir = (t.direction || '').toLowerCase();
        return dir === 'in' || dir === 'incoming';
      }) || threadsArr[0];
      if (inbound) {
        const c = inbound.content || inbound.body || inbound.description || inbound.contentPlainText || inbound.mailContent;
        if (c) {
          return { content: c, source: 'Thread (ticket)' };
        }
      }

      const msgs = Array.isArray(lastMessages) ? lastMessages : [];
      if (msgs.length > 0) {
        const m = msgs.find(x => (x.direction || '').toLowerCase() === 'in') || msgs[0];
        const c = m && (m.content || m.body || m.description || m.contentPlainText || m.mailContent || m.summary);
        if (c) return { content: c, source: 'Message' };
      }

      // 4) historique : propriété "Content" (ex: notes/commentaires)
      const histContent = pickHistoryContent();
      if (histContent) {
        return { content: histContent, source: 'Historique' };
      }

      if (Array.isArray(lastConversations)) {
        const conv = lastConversations.find(c => (c.direction || '').toLowerCase() === 'in') || lastConversations[0];
        if (conv) {
          const c = conv.content || conv.body || conv.description || conv.contentPlainText || conv.mailContent || conv.summary;
          if (c) return { content: c, source: 'Conversation' };
        }
      }

      return { content: '', source: '' };
    }

    function renderInitialContent() {
      const bodyEl = document.getElementById('initialContentBody');
      const srcEl = document.getElementById('initialContentSource');
      if (!bodyEl || !srcEl) return;

      const { content, source } = pickInitialContent();
      if (!content) {
        bodyEl.textContent = 'Contenu initial non trouvé pour ce ticket.';
        srcEl.textContent = '';
        return;
      }

      const textVersion = stripHtml(content);
      bodyEl.textContent = textVersion || content;
      // Ne pas afficher la source au client
      srcEl.textContent = '';
    }

    function updateResolutionDisplay() {
      const resEl = document.getElementById('resolutionBody');
      if (!resEl) return;
      // Priorité : résolution fournie par l'API
      if (lastDetails && lastDetails.resolution && lastDetails.resolution !== '(Aucune résolution encodée)') {
        resEl.textContent = lastDetails.resolution;
        return;
      }
      const notes = extractHistoryNotes();
      if (notes.length > 0) {
        resEl.innerHTML = notes
          .map(n => {
            const date = n.when ? new Date(n.when).toLocaleString() : '';
            return `<div>${date ? date + ' - ' : ''}${n.text}</div>`;
          })
          .join('');
        return;
      }
      const histContent = pickHistoryContent();
      if (histContent) {
        resEl.textContent = stripHtml(histContent) || histContent;
      }
    }

    debugTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        debugTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        if (target === 'history') {
          debugDetails.style.display = 'none';
          debugHistory.style.display = 'block';
        } else {
          debugDetails.style.display = 'block';
          debugHistory.style.display = 'none';
        }
      });
    });

    refreshBtn.addEventListener('click', loadTickets);
    authSubmit.addEventListener('click', login);
    authPassword.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        login();
      }
    });

checkSession().then(ok => {
  if (ok) {
    loadTickets();
  }
});
</script>
</body>
</html>
